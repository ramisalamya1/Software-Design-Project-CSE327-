<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customize Medical Package</title>
    <link href="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body>
    <!-- Previous HTML content remains exactly the same until the scripts section -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>
        AOS.init();

        // Add getCookie function to handle CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Global variables to store selections
        let selectedOptions = {
            hospital: null,
            accommodation: null,
            transport: null,
            assistance: [],
            diet: null,
            rehab: null
        };

        // Handle option card selection
        document.querySelectorAll('.option-card').forEach(card => {
            card.addEventListener('click', function() {
                const type = this.dataset.type;
                const id = this.dataset.id;
                
                // Handle multiple selections for assistance
                if (type === 'assistance') {
                    this.classList.toggle('selected');
                    if (this.classList.contains('selected')) {
                        selectedOptions.assistance.push(id);
                    } else {
                        selectedOptions.assistance = selectedOptions.assistance.filter(x => x !== id);
                    }
                } else {
                    // Single selection for other types
                    document.querySelectorAll(`.option-card[data-type="${type}"]`).forEach(c => {
                        c.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedOptions[type] = id;
                }
                
                updateCostSummary();
            });
        });

        // Handle hospital selection
        document.getElementById('hospital').addEventListener('change', function() {
            selectedOptions.hospital = this.value;
            updateCostSummary();
        });

        // Update cost summary
        function updateCostSummary() {
            let total = 0;

            // Treatment cost
            const hospital = document.getElementById('hospital');
            const treatmentCost = hospital.selectedOptions[0]?.dataset.cost || 0;
            document.getElementById('treatmentCost').textContent = `₹${treatmentCost}`;
            total += Number(treatmentCost);

            // Accommodation cost
            const accCard = document.querySelector('.option-card[data-type="accommodation"].selected');
            const accCost = accCard ? Number(accCard.dataset.cost) : 0;
            document.getElementById('accommodationCost').textContent = `₹${accCost}`;
            total += accCost;

            // Transport cost
            const transportCard = document.querySelector('.option-card[data-type="transport"].selected');
            const transportCost = transportCard ? Number(transportCard.dataset.cost) : 0;
            document.getElementById('transportCost').textContent = `₹${transportCost}`;
            total += transportCost;

            // Assistance cost
            const assistanceCost = Array.from(document.querySelectorAll('.option-card[data-type="assistance"].selected'))
                .reduce((sum, card) => sum + Number(card.dataset.cost), 0);
            document.getElementById('assistanceCost').textContent = `₹${assistanceCost}`;
            total += assistanceCost;

            // Dietary cost
            const dietCard = document.querySelector('.option-card[data-type="diet"].selected');
            const dietCost = dietCard ? Number(dietCard.dataset.cost) : 0;
            document.getElementById('dietaryCost').textContent = `₹${dietCost}`;
            total += dietCost;

            // Rehabilitation cost
            const rehabCard = document.querySelector('.option-card[data-type="rehab"].selected');
            const rehabCost = rehabCard ? Number(rehabCard.dataset.cost) : 0;
            document.getElementById('rehabCost').textContent = `₹${rehabCost}`;
            total += rehabCost;

            // Update total
            document.getElementById('totalCost').textContent = `₹${total}`;
        }

        // Handle form submission
        document.getElementById('packageForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                user_name: document.getElementById('userName').value,
                treatment_date: document.getElementById('treatmentDate').value,
                hospital: selectedOptions.hospital,
                accommodation: selectedOptions.accommodation,
                transport: selectedOptions.transport,
                travel_assistance: selectedOptions.assistance,
                dietary_option: selectedOptions.diet,
                rehabilitation: selectedOptions.rehab,
                total_cost: document.getElementById('totalCost').textContent.replace('₹', ''),
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch('/package/save-package/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    window.location.href = data.redirect_url;
                } else {
                    alert('Error saving package: ' + data.message);
                }
            } catch (error) {
                alert('Error saving package: ' + error.message);
            }
        });
    </script>
</body>
</html>
